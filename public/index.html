<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Spotify Controller</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SpotifyCtrl">
    <meta name="theme-color" content="#1DB954">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            background-color: #282828;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .button:active {
            background-color: #1ed760;
            transform: scale(0.98);
        }
        #nowPlaying, #trackInfo, #errorMessage, #playbackStatus {
            margin: 20px 0;
            padding: 15px;
            background-color: #3E3E3E;
            border-radius: 8px;
            font-size: 16px;
        }
        #errorMessage {
            background-color: #5E3E3E;
            display: none;
        }
        #playbackStatus {
            background-color: #2E4E3E;
            text-align: center;
            font-weight: bold;
        }
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .control-button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 20px;
            margin: 10px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 24px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        #playPauseButton {
            background-color: #1DB954;
            width: 100px;
            height: 100px;
            font-size: 30px;
        }
        #seekBackward {
            background-color: #535353;
        }
        #seekForward {
            background-color: #535353;
        }
        .help-text {
            margin-top: 20px;
            font-size: 14px;
            color: #b3b3b3;
            line-height: 1.5;
        }
        .spotify-link {
            color: #1DB954;
            text-decoration: none;
        }
        .spotify-link:hover {
            text-decoration: underline;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active {
            background-color: #1DB954;
            box-shadow: 0 0 8px #1DB954;
        }
        .status-inactive {
            background-color: #888;
        }
        .status-paused {
            background-color: #FFA500;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }
        .logout-link {
            color: #888;
            text-decoration: underline;
            cursor: pointer;
        }
        .version-info {
            display: block;
            margin-top: 8px;
            color: #666;
            font-size: 10px;
        }
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .button {
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Controller</h1>
        <div id="loginSection">
            <a href="/login" class="button">Spotifyにログイン</a>
        </div>
        <div id="controlSection" style="display: none;">
            <div id="playbackStatus">
                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                <span id="statusText">接続中...</span>
            </div>
            <div id="nowPlaying">再生中の曲: 取得中... <span class="loading"></span></div>
            <div id="trackInfo">アーティスト: 取得中...</div>
            <div id="errorMessage"></div>
            
            <div class="controls">
                <button id="seekBackward" class="control-button">-5秒</button>
                <button id="playPauseButton" class="control-button">▶</button>
                <button id="seekForward" class="control-button">+5秒</button>
            </div>
            
            <div class="help-text">
                <p>※ このコントローラーを使用するには、Spotifyアプリで再生を開始してください。</p>
                <p><a href="https://open.spotify.com" class="spotify-link" target="_blank">Spotify Web Playerを開く</a></p>
            </div>
            
            <div class="footer">
                <span class="logout-link" id="logoutButton">ログアウト</span>
                <span class="version-info" id="versionInfo">v1.1.0</span>
            </div>
        </div>
    </div>

    <script>
        let accessToken = null;
        let sessionId = null;
        let isPlaying = false;
        let updateInterval = null;
        let sessionCheckInterval = null;
        let errorCount = 0;
        let lastTrackInfo = null;
        let deviceActive = false;
        let tokenRefreshTimeout = null;

        // ハッシュパラメータからアクセストークンとセッションIDを取得
        function getHashParams() {
            let hashParams = {};
            let e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        // セッション情報をローカルストレージに保存
        function saveSessionToStorage(token, session) {
            if (token && session) {
                localStorage.setItem('spotify_access_token', token);
                localStorage.setItem('spotify_session_id', session);
                localStorage.setItem('spotify_session_time', Date.now().toString());
                accessToken = token;
                sessionId = session;
            }
        }

        // ローカルストレージからセッション情報を取得
        function getSessionFromStorage() {
            return {
                accessToken: localStorage.getItem('spotify_access_token'),
                sessionId: localStorage.getItem('spotify_session_id'),
                sessionTime: localStorage.getItem('spotify_session_time')
            };
        }

        // 最後に再生していた曲の情報をローカルストレージに保存
        function saveLastTrackInfo(trackInfo) {
            if (trackInfo) {
                localStorage.setItem('spotify_last_track', JSON.stringify(trackInfo));
                lastTrackInfo = trackInfo;
            }
        }

        // ローカルストレージから最後に再生していた曲の情報を取得
        function getLastTrackInfo() {
            const savedTrack = localStorage.getItem('spotify_last_track');
            return savedTrack ? JSON.parse(savedTrack) : null;
        }

        // セッション情報をローカルストレージから削除
        function removeSessionFromStorage() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_session_id');
            localStorage.removeItem('spotify_session_time');
            accessToken = null;
            sessionId = null;
        }

        // セッションの有効性をチェック
        async function checkSessionValidity() {
            if (!sessionId) return false;
            
            try {
                // 最大3回まで再試行
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    try {
                        const response = await fetch(`/session-status?session_id=${sessionId}`);
                        if (!response.ok) {
                            console.error(`Session check attempt ${attempts} failed:`, response.status);
                            
                            if (attempts >= maxAttempts) {
                                return false;
                            }
                            
                            // 少し待ってから再試行
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        
                        const data = await response.json();
                        return data.valid;
                    } catch (error) {
                        console.error(`Session check attempt ${attempts} error:`, error);
                        
                        if (attempts >= maxAttempts) {
                            return false;
                        }
                        
                        // 少し待ってから再試行
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error checking session validity:', error);
                return false;
            }
        }

        // トークンを更新する
        async function refreshToken() {
            try {
                if (!sessionId) {
                    throw new Error('セッションIDがありません');
                }
                
                // 最大3回まで再試行
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    try {
                        const response = await fetch(`/token?session_id=${sessionId}`);
                        if (!response.ok) {
                            console.error(`Token refresh attempt ${attempts} failed:`, response.status);
                            
                            if (attempts >= maxAttempts) {
                                throw new Error('トークンの更新に失敗しました');
                            }
                            
                            // 少し待ってから再試行
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        
                        const data = await response.json();
                        if (data.access_token) {
                            accessToken = data.access_token;
                            localStorage.setItem('spotify_access_token', accessToken);
                            localStorage.setItem('spotify_session_time', Date.now().toString());
                            console.log('トークンを更新しました');
                            return true;
                        } else {
                            throw new Error('トークンの取得に失敗しました');
                        }
                    } catch (error) {
                        console.error(`Token refresh attempt ${attempts} error:`, error);
                        
                        if (attempts >= maxAttempts) {
                            throw error;
                        }
                        
                        // 少し待ってから再試行
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                throw new Error('トークンの更新に失敗しました');
            } catch (error) {
                console.error('トークン更新エラー:', error);
                return false;
            }
        }

        // 定期的にセッションをチェック
        function setupSessionCheck() {
            // 既存のインターバルをクリア
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            
            // 5分ごとにセッションの有効性をチェック
            sessionCheckInterval = setInterval(async () => {
                const isValid = await checkSessionValidity();
                if (!isValid) {
                    console.log('Session is no longer valid');
                    const refreshed = await refreshToken();
                    if (!refreshed) {
                        showError('セッションの有効期限が切れました。再度ログインしてください。');
                        logout();
                    }
                }
            }, 5 * 60 * 1000);
        }

        // ログアウト処理
        function logout() {
            removeSessionFromStorage();
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
            }
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('controlSection').style.display = 'none';
            window.location.reload();
        }

        // 再生状態を表示する
        function updateStatusDisplay(isActive, isPlaying) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!isActive) {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'デバイス未接続';
                deviceActive = false;
            } else if (isPlaying) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = '再生中';
                deviceActive = true;
            } else {
                statusIndicator.className = 'status-indicator status-paused';
                statusText.textContent = '一時停止中';
                deviceActive = true;
            }
        }

        // トラック情報を表示する
        function displayTrackInfo(trackData) {
            if (!trackData) return;
            
            const trackName = trackData.name || '不明な曲';
            const artistName = trackData.artists ? trackData.artists.map(artist => artist.name).join(', ') : '不明なアーティスト';
            
            document.getElementById('nowPlaying').innerHTML = `再生中の曲: ${trackName}`;
            document.getElementById('trackInfo').textContent = `アーティスト: ${artistName}`;
            
            // 最後に再生していた曲の情報を保存
            saveLastTrackInfo({
                name: trackName,
                artists: trackData.artists || [],
                id: trackData.id
            });
        }

        window.onload = async () => {
            // バージョン情報を表示
            document.getElementById('versionInfo').textContent = 'v1.1.0 (' + new Date().toISOString().split('T')[0] + ')';
            
            // URLハッシュからトークンとセッションIDを取得
            const params = getHashParams();
            if (params.access_token && params.session_id) {
                accessToken = params.access_token;
                sessionId = params.session_id;
                saveSessionToStorage(accessToken, sessionId);
                // URLからハッシュを削除
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // ローカルストレージからセッション情報を取得
                const session = getSessionFromStorage();
                accessToken = session.accessToken;
                sessionId = session.sessionId;
                
                // セッションが古すぎる場合は更新
                const sessionTime = parseInt(session.sessionTime || '0');
                const now = Date.now();
                if (sessionTime && now - sessionTime > 6 * 60 * 60 * 1000) { // 6時間以上経過
                    console.log('Session is too old, refreshing token');
                    if (sessionId) {
                        try {
                            const refreshed = await refreshToken();
                            if (!refreshed) {
                                // トークン更新に失敗した場合はセッションをクリア
                                removeSessionFromStorage();
                                accessToken = null;
                                sessionId = null;
                            }
                        } catch (error) {
                            console.error('Error refreshing token on load:', error);
                            // エラーが発生した場合でもセッションを維持
                        }
                    }
                }
            }
            
            // 最後に再生していた曲の情報を取得
            lastTrackInfo = getLastTrackInfo();
            
            if (accessToken && sessionId) {
                // セッションの有効性をチェック
                const isValid = await checkSessionValidity();
                if (!isValid) {
                    console.log('Session is not valid, trying to refresh token');
                    const refreshed = await refreshToken();
                    if (!refreshed) {
                        console.log('Failed to refresh token, redirecting to login');
                        removeSessionFromStorage();
                        document.getElementById('loginSection').style.display = 'block';
                        document.getElementById('controlSection').style.display = 'none';
                        return;
                    }
                }
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('controlSection').style.display = 'block';
                
                // 最後に再生していた曲の情報があれば表示
                if (lastTrackInfo) {
                    displayTrackInfo(lastTrackInfo);
                    updateStatusDisplay(false, false);
                }
                
                // 定期的なセッションチェックを設定
                setupSessionCheck();
                
                updatePlaybackState();
                // 定期的に再生状態を更新
                updateInterval = setInterval(updatePlaybackState, 1000);
                
                // ログアウトボタンのイベントリスナーを設定
                document.getElementById('logoutButton').addEventListener('click', logout);
            }
        };

        // エラーメッセージを表示する関数
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // エラーメッセージを非表示にする関数
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
            errorCount = 0;
        }

        // 認証エラーを処理する関数
        async function handleAuthError() {
            // トークンの更新を試みる
            const refreshed = await refreshToken();
            if (!refreshed) {
                // 更新に失敗した場合はログイン画面を表示
                showError('認証の有効期限が切れました。再度ログインしてください。');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('controlSection').style.display = 'none';
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                if (sessionCheckInterval) {
                    clearInterval(sessionCheckInterval);
                }
                removeSessionFromStorage();
                return false;
            }
            return true;
        }

        // 再生状態を更新する関数
        async function updatePlaybackState() {
            if (!sessionId) {
                showError('セッションが無効です。再度ログインしてください。');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('controlSection').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/current-playback?session_id=${sessionId}`);
                const data = await response.json();

                if (data && data.item) {
                    // 正常に再生情報を取得できた場合
                    hideError();
                    isPlaying = data.is_playing;
                    displayTrackInfo(data.item);
                    updateStatusDisplay(true, isPlaying);
                    document.getElementById('playPauseButton').textContent = isPlaying ? '⏸' : '▶';
                } else if (data && data.error) {
                    // エラーがある場合
                    errorCount++;
                    console.error('Playback error:', data.error);
                    
                    if (data.error.includes('No active device found')) {
                        // アクティブなデバイスがない場合でも、最後に再生していた曲の情報を表示
                        updateStatusDisplay(false, false);
                        if (lastTrackInfo) {
                            displayTrackInfo(lastTrackInfo);
                        }
                        showError('アクティブなデバイスが見つかりません。Spotifyアプリで再生を開始してください。');
                    } else if (data.error.includes('No valid access token') || data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                        const refreshed = await handleAuthError();
                        if (!refreshed) {
                            return;
                        }
                    } else {
                        showError('エラー: ' + data.error);
                    }
                    
                    // エラーが続く場合は更新間隔を長くする
                    if (errorCount > 5 && updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = setInterval(updatePlaybackState, 5000);
                    }
                }
            } catch (error) {
                console.error('Error updating playback state:', error);
                showError('再生状態の取得に失敗しました: ' + error.message);
                errorCount++;
                
                // エラーが続く場合は更新間隔を長くする
                if (errorCount > 5 && updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = setInterval(updatePlaybackState, 5000);
                }
            }
        }

        // 再生位置を変更する関数
        async function seekPosition(position) {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return;
            }
            
            try {
                const response = await fetch(`/seek?session_id=${sessionId}&position=${position}`);
                const data = await response.json();
                
                if (data.success) {
                    updatePlaybackState();
                    hideError();
                } else {
                    console.error('Seek failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                seekPosition(position);
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                        } else {
                            showError('シーク失敗: ' + data.error);
                        }
                    }
                }
            } catch (error) {
                console.error('Error seeking position:', error);
                showError('シーク中にエラーが発生しました: ' + error.message);
            }
        }

        // 再生/一時停止を切り替える関数
        async function togglePlayPause() {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive && !isPlaying) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return;
            }
            
            const endpoint = isPlaying ? '/pause' : '/play';
            try {
                const response = await fetch(`${endpoint}?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    isPlaying = !isPlaying;
                    document.getElementById('playPauseButton').textContent = isPlaying ? '⏸' : '▶';
                    updateStatusDisplay(true, isPlaying);
                    hideError();
                } else {
                    console.error('Playback toggle failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                togglePlayPause();
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                        } else {
                            showError('再生/一時停止の切り替えに失敗しました: ' + data.error);
                        }
                    }
                }
            } catch (error) {
                console.error('Error toggling playback:', error);
                showError('再生/一時停止の切り替え中にエラーが発生しました: ' + error.message);
            }
        }

        // イベントリスナーの設定
        document.getElementById('seekBackward').addEventListener('click', async () => {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return;
            }
            
            try {
                const response = await fetch(`/current-playback?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data && data.progress_ms !== undefined) {
                    const newPosition = Math.max(0, data.progress_ms - 5000);
                    seekPosition(newPosition);
                } else if (data && data.error) {
                    if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                        const refreshed = await handleAuthError();
                        if (!refreshed) return;
                    } else if (data.error.includes('No active device')) {
                        showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                    } else {
                        showError('現在の再生位置を取得できません: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Error getting current position:', error);
                showError('現在の再生位置の取得中にエラーが発生しました: ' + error.message);
            }
        });

        document.getElementById('seekForward').addEventListener('click', async () => {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return;
            }
            
            try {
                const response = await fetch(`/current-playback?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data && data.progress_ms !== undefined) {
                    seekPosition(data.progress_ms + 5000);
                } else if (data && data.error) {
                    if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                        const refreshed = await handleAuthError();
                        if (!refreshed) return;
                    } else if (data.error.includes('No active device')) {
                        showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                    } else {
                        showError('現在の再生位置を取得できません: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Error getting current position:', error);
                showError('現在の再生位置の取得中にエラーが発生しました: ' + error.message);
            }
        });

        document.getElementById('playPauseButton').addEventListener('click', togglePlayPause);

        // ダブルタップによるズームを防止
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ページを離れる時にインターバルをクリア
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
            }
        });
    </script>
</body>
</html> 