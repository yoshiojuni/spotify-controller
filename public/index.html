<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spotify Controller</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SpotifyCtrl">
    <meta name="theme-color" content="#1DB954">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            background-color: #282828;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .button:active {
            background-color: #1ed760;
            transform: scale(0.98);
        }
        #nowPlaying, #trackInfo, #errorMessage {
            margin: 20px 0;
            padding: 15px;
            background-color: #3E3E3E;
            border-radius: 8px;
            font-size: 16px;
        }
        #errorMessage {
            background-color: #5E3E3E;
            display: none;
        }
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .control-button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 20px;
            margin: 10px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 24px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        #playPauseButton {
            background-color: #1DB954;
            width: 100px;
            height: 100px;
            font-size: 30px;
        }
        #seekBackward {
            background-color: #535353;
        }
        #seekForward {
            background-color: #535353;
        }
        .help-text {
            margin-top: 20px;
            font-size: 14px;
            color: #b3b3b3;
            line-height: 1.5;
        }
        .spotify-link {
            color: #1DB954;
            text-decoration: none;
        }
        .spotify-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .button {
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Controller</h1>
        <div id="loginSection">
            <a href="/login" class="button">Spotifyにログイン</a>
        </div>
        <div id="controlSection" style="display: none;">
            <div id="nowPlaying">再生中の曲: 取得中...</div>
            <div id="trackInfo">アーティスト: 取得中...</div>
            <div id="errorMessage"></div>
            
            <div class="controls">
                <button id="seekBackward" class="control-button">-5秒</button>
                <button id="playPauseButton" class="control-button">▶</button>
                <button id="seekForward" class="control-button">+5秒</button>
            </div>
            
            <div class="help-text">
                <p>※ このコントローラーを使用するには、Spotifyアプリで再生を開始してください。</p>
                <p><a href="https://open.spotify.com" class="spotify-link" target="_blank">Spotify Web Playerを開く</a></p>
            </div>
        </div>
    </div>

    <script>
        let accessToken = null;
        let isPlaying = false;
        let updateInterval = null;
        let errorCount = 0;

        // ハッシュパラメータからアクセストークンを取得
        function getHashParams() {
            let hashParams = {};
            let e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        window.onload = () => {
            const params = getHashParams();
            accessToken = params.access_token;
            
            if (accessToken) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('controlSection').style.display = 'block';
                updatePlaybackState();
                // 定期的に再生状態を更新
                updateInterval = setInterval(updatePlaybackState, 1000);
            } else {
                // トークンがない場合はサーバーから取得を試みる
                fetch('/token')
                    .then(response => response.json())
                    .then(data => {
                        if (data.access_token) {
                            accessToken = data.access_token;
                            document.getElementById('loginSection').style.display = 'none';
                            document.getElementById('controlSection').style.display = 'block';
                            updatePlaybackState();
                            // 定期的に再生状態を更新
                            updateInterval = setInterval(updatePlaybackState, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching token:', error);
                        showError('トークンの取得に失敗しました。再度ログインしてください。');
                    });
            }
        };

        // エラーメッセージを表示する関数
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // エラーメッセージを非表示にする関数
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
            errorCount = 0;
        }

        // 再生状態を更新する関数
        function updatePlaybackState() {
            fetch('/current-playback')
                .then(response => response.json())
                .then(data => {
                    if (data && data.item) {
                        // 正常に再生情報を取得できた場合
                        hideError();
                        isPlaying = data.is_playing;
                        const trackName = data.item.name;
                        const artistName = data.item.artists.map(artist => artist.name).join(', ');
                        document.getElementById('nowPlaying').textContent = `再生中の曲: ${trackName}`;
                        document.getElementById('trackInfo').textContent = `アーティスト: ${artistName}`;
                        document.getElementById('playPauseButton').textContent = isPlaying ? '⏸' : '▶';
                    } else if (data && data.error) {
                        // エラーがある場合
                        errorCount++;
                        console.error('Playback error:', data.error);
                        
                        if (data.error.includes('No active device found')) {
                            showError('アクティブなデバイスが見つかりません。Spotifyアプリで再生を開始してください。');
                        } else if (data.error.includes('No access token') || data.error.includes('token')) {
                            showError('認証エラー: ' + data.error);
                            document.getElementById('loginSection').style.display = 'block';
                            document.getElementById('controlSection').style.display = 'none';
                            if (updateInterval) {
                                clearInterval(updateInterval);
                            }
                        } else {
                            showError('エラー: ' + data.error);
                        }
                        
                        // エラーが続く場合は更新間隔を長くする
                        if (errorCount > 5 && updateInterval) {
                            clearInterval(updateInterval);
                            updateInterval = setInterval(updatePlaybackState, 5000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating playback state:', error);
                    showError('再生状態の取得に失敗しました: ' + error.message);
                    errorCount++;
                    
                    // エラーが続く場合は更新間隔を長くする
                    if (errorCount > 5 && updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = setInterval(updatePlaybackState, 5000);
                    }
                });
        }

        // 再生位置を変更する関数
        function seekPosition(position) {
            fetch(`/seek?position=${position}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePlaybackState();
                        hideError();
                    } else {
                        console.error('Seek failed:', data);
                        if (data.error) {
                            showError('シーク失敗: ' + data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error seeking position:', error);
                    showError('シーク中にエラーが発生しました: ' + error.message);
                });
        }

        // 再生/一時停止を切り替える関数
        function togglePlayPause() {
            const endpoint = isPlaying ? '/pause' : '/play';
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isPlaying = !isPlaying;
                        document.getElementById('playPauseButton').textContent = isPlaying ? '⏸' : '▶';
                        hideError();
                    } else {
                        console.error('Playback toggle failed:', data);
                        if (data.error) {
                            showError('再生/一時停止の切り替えに失敗しました: ' + data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error toggling playback:', error);
                    showError('再生/一時停止の切り替え中にエラーが発生しました: ' + error.message);
                });
        }

        // イベントリスナーの設定
        document.getElementById('seekBackward').addEventListener('click', () => {
            fetch('/current-playback')
                .then(response => response.json())
                .then(data => {
                    if (data && data.progress_ms !== undefined) {
                        const newPosition = Math.max(0, data.progress_ms - 5000);
                        seekPosition(newPosition);
                    } else if (data && data.error) {
                        showError('現在の再生位置を取得できません: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error getting current position:', error);
                    showError('現在の再生位置の取得中にエラーが発生しました: ' + error.message);
                });
        });

        document.getElementById('seekForward').addEventListener('click', () => {
            fetch('/current-playback')
                .then(response => response.json())
                .then(data => {
                    if (data && data.progress_ms !== undefined) {
                        seekPosition(data.progress_ms + 5000);
                    } else if (data && data.error) {
                        showError('現在の再生位置を取得できません: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error getting current position:', error);
                    showError('現在の再生位置の取得中にエラーが発生しました: ' + error.message);
                });
        });

        document.getElementById('playPauseButton').addEventListener('click', togglePlayPause);

        // ダブルタップによるズームを防止
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ページを離れる時にインターバルをクリア
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 