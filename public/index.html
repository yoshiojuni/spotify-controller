<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Spotify Controller</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SpotifyCtrl">
    <meta name="theme-color" content="#1DB954">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            background-color: #282828;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: transform 0.1s ease, background-color 0.2s ease, opacity 0.2s ease;
        }
        .button:active {
            background-color: #1ed760;
            transform: scale(0.98);
        }
        #nowPlaying, #trackInfo, #errorMessage, #playbackStatus {
            margin: 20px 0;
            padding: 15px;
            background-color: #3E3E3E;
            border-radius: 8px;
            font-size: 16px;
        }
        #errorMessage {
            background-color: #5E3E3E;
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 80%;
            text-align: center;
        }
        #playbackStatus {
            background-color: #2E4E3E;
            text-align: center;
            font-weight: bold;
        }
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .control-button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 20px;
            margin: 10px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 24px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, opacity 0.3s;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        .control-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        #playPauseButton {
            background-color: #1DB954;
            width: 100px;
            height: 100px;
            font-size: 30px;
        }
        #seekBackward {
            background-color: #535353;
        }
        #seekForward {
            background-color: #535353;
        }
        .help-text {
            margin-top: 20px;
            font-size: 14px;
            color: #b3b3b3;
            line-height: 1.5;
        }
        .spotify-link {
            color: #1DB954;
            text-decoration: none;
        }
        .spotify-link:hover {
            text-decoration: underline;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active {
            background-color: #1DB954;
            box-shadow: 0 0 8px #1DB954;
        }
        .status-inactive {
            background-color: #888;
        }
        .status-paused {
            background-color: #FFA500;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }
        .logout-link {
            color: #888;
            text-decoration: underline;
            cursor: pointer;
        }
        .version-info {
            display: block;
            margin-top: 8px;
            color: #666;
            font-size: 10px;
        }
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .button {
                padding: 12px 20px;
            }
        }
        #trackInfo {
            margin-top: 20px;
            text-align: center;
        }
        #albumArt {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #trackName {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #artistName {
            font-size: 16px;
            color: #b3b3b3;
            margin-bottom: 5px;
        }
        #progressDisplay {
            font-size: 14px;
            color: #b3b3b3;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        #errorMessage {
            color: #ff5252;
            background-color: rgba(255, 82, 82, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Controller</h1>
        <div id="loginSection">
            <a href="/login" id="loginButton" class="button">Spotifyにログイン</a>
        </div>
        <div id="controlSection" style="display: none;">
            <div id="playbackStatus">
                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                <span id="statusText">接続中...</span>
            </div>
            <div id="nowPlaying">再生中の曲: 取得中... <span class="loading"></span></div>
            <div id="trackInfo" style="display: none;">
                <img id="albumArt" src="" alt="Album Art" style="display: none;">
                <div id="trackName"></div>
                <div id="artistName"></div>
                <div id="progressDisplay">--:-- / --:--</div>
                <div id="trackPlaybackStatus" style="display: none;"></div>
            </div>
            <div id="errorMessage"></div>
            
            <div class="controls">
                <button id="previousTrack" class="control-button">⏮</button>
                <button id="seekBackward" class="control-button">-5秒</button>
                <button id="playPauseButton" class="control-button">▶</button>
                <button id="seekForward" class="control-button">+5秒</button>
                <button id="nextTrack" class="control-button">⏭</button>
            </div>
            
            <div class="help-text">
                <p>※ このコントローラーを使用するには、Spotifyアプリで再生を開始してください。</p>
                <p><a href="https://open.spotify.com" class="spotify-link" target="_blank">Spotify Web Playerを開く</a></p>
            </div>
            
            <div class="footer">
                <span class="logout-link" id="logoutButton">ログアウト</span>
            </div>
        </div>
    </div>

    <script>
        let accessToken = null;
        let sessionId = null;
        let isPlaying = false;
        let updateInterval = null;
        let sessionCheckInterval = null;
        let errorCount = 0;
        let lastTrackInfo = null;
        let deviceActive = false;
        let tokenRefreshTimeout = null;
        
        // 連続ボタン押下のカウント用変数
        let seekBackwardCount = 0;
        let seekForwardCount = 0;
        let seekBackwardTimer = null;
        let seekForwardTimer = null;
        const SEEK_TIMEOUT = 300; // 連続押下と判定する時間間隔（ミリ秒）を短縮（500ms→300ms）
        const SEEK_STEP = 5000; // 1回の早送り・巻き戻し時間（ミリ秒）

        // ハッシュパラメータからアクセストークンとセッションIDを取得
        function getHashParams() {
            let hashParams = {};
            let e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        // セッション情報をローカルストレージに保存
        function saveSessionToStorage(token, session) {
            if (token && session) {
                localStorage.setItem('spotify_access_token', token);
                localStorage.setItem('spotify_session_id', session);
                localStorage.setItem('spotify_session_time', Date.now().toString());
                accessToken = token;
                sessionId = session;
            }
        }

        // ローカルストレージからセッション情報を取得
        function getSessionFromStorage() {
            return {
                accessToken: localStorage.getItem('spotify_access_token'),
                sessionId: localStorage.getItem('spotify_session_id'),
                sessionTime: localStorage.getItem('spotify_session_time')
            };
        }

        // 最後に再生していた曲の情報をローカルストレージに保存
        function saveLastTrackInfo(trackInfo) {
            if (trackInfo) {
                localStorage.setItem('spotify_last_track', JSON.stringify(trackInfo));
                lastTrackInfo = trackInfo;
            }
        }

        // ローカルストレージから最後に再生していた曲の情報を取得
        function getLastTrackInfo() {
            const savedTrack = localStorage.getItem('spotify_last_track');
            return savedTrack ? JSON.parse(savedTrack) : null;
        }

        // セッション情報をローカルストレージから削除
        function removeSessionFromStorage() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_session_id');
            localStorage.removeItem('spotify_session_time');
            accessToken = null;
            sessionId = null;
        }

        // セッションの有効性をチェック
        async function checkSessionValidity() {
            if (!sessionId) return false;
            
            try {
                // 最大3回まで再試行
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    try {
                        const response = await fetch(`/session-status?session_id=${sessionId}`);
                        if (!response.ok) {
                            console.error(`Session check attempt ${attempts} failed:`, response.status);
                            
                            if (attempts >= maxAttempts) {
                                return false;
                            }
                            
                            // 少し待ってから再試行
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        
                        const data = await response.json();
                        return data.valid;
                    } catch (error) {
                        console.error(`Session check attempt ${attempts} error:`, error);
                        
                        if (attempts >= maxAttempts) {
                            return false;
                        }
                        
                        // 少し待ってから再試行
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error checking session validity:', error);
                return false;
            }
        }

        // トークンを更新する
        async function refreshToken() {
            try {
                if (!sessionId) {
                    throw new Error('セッションIDがありません');
                }
                
                // 最大3回まで再試行
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    try {
                        const response = await fetch(`/token?session_id=${sessionId}`);
                        if (!response.ok) {
                            console.error(`Token refresh attempt ${attempts} failed:`, response.status);
                            
                            if (attempts >= maxAttempts) {
                                throw new Error('トークンの更新に失敗しました');
                            }
                            
                            // 少し待ってから再試行
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        
                        const data = await response.json();
                        if (data.access_token) {
                            accessToken = data.access_token;
                            localStorage.setItem('spotify_access_token', accessToken);
                            localStorage.setItem('spotify_session_time', Date.now().toString());
                            console.log('トークンを更新しました');
                            return true;
                        } else {
                            throw new Error('トークンの取得に失敗しました');
                        }
                    } catch (error) {
                        console.error(`Token refresh attempt ${attempts} error:`, error);
                        
                        if (attempts >= maxAttempts) {
                            throw error;
                        }
                        
                        // 少し待ってから再試行
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                throw new Error('トークンの更新に失敗しました');
            } catch (error) {
                console.error('トークン更新エラー:', error);
                return false;
            }
        }

        // 定期的にセッションをチェック
        function setupSessionCheck() {
            // 既存のインターバルをクリア
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            
            // 5分ごとにセッションの有効性をチェック
            sessionCheckInterval = setInterval(async () => {
                const isValid = await checkSessionValidity();
                if (!isValid) {
                    console.log('Session is no longer valid');
                    const refreshed = await refreshToken();
                    if (!refreshed) {
                        showError('セッションの有効期限が切れました。自動的に再ログインします...');
                        
                        // 現在のURLを保存して自動再ログイン
                        autoRelogin();
                    }
                }
            }, 5 * 60 * 1000);
        }

        // 自動再ログイン処理
        function autoRelogin() {
            // 現在のURLを保存
            localStorage.setItem('spotify_redirect_after_login', window.location.href);
            
            // 3秒後に自動的にログインページにリダイレクト
            setTimeout(() => {
                window.location.href = '/login';
            }, 3000);
        }

        // ログアウト処理
        function logout() {
            removeSessionFromStorage();
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
            }
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('controlSection').style.display = 'none';
            window.location.reload();
        }

        // 再生状態を表示する
        function updateStatusDisplay(isActive, isPlaying) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!isActive) {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'デバイス未接続';
                deviceActive = false;
            } else if (isPlaying) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = '再生中';
                deviceActive = true;
            } else {
                statusIndicator.className = 'status-indicator status-paused';
                statusText.textContent = '一時停止中';
                deviceActive = true;
            }
        }

        // トラック情報を表示する
        function displayTrackInfo(trackData) {
            if (!trackData) return;
            
            const trackName = trackData.name || '不明な曲';
            const artistName = trackData.artists ? trackData.artists.map(artist => artist.name).join(', ') : '不明なアーティスト';
            
            document.getElementById('nowPlaying').innerHTML = `再生中の曲: ${trackName}`;
            
            // 最後に再生していた曲の情報を保存
            saveLastTrackInfo({
                name: trackName,
                artists: trackData.artists || [],
                id: trackData.id
            });
        }

        window.onload = async () => {
            // バージョン情報を表示（古いコードを削除）
            // document.getElementById('versionInfo').textContent = 'v1.3.0 (' + new Date().toISOString().split('T')[0] + ')';
            
            // ログインボタンのイベントリスナーを設定
            document.getElementById('loginButton').addEventListener('click', function(e) {
                // 現在のURLを保存
                localStorage.setItem('spotify_redirect_after_login', window.location.href);
            });
            
            // フッターのログアウトリンクにイベントリスナーを設定
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', logout);
            }
            
            // URLハッシュからトークンとセッションIDを取得
            const params = getHashParams();
            if (params.access_token && params.session_id) {
                accessToken = params.access_token;
                sessionId = params.session_id;
                saveSessionToStorage(accessToken, sessionId);
                
                // リダイレクト先があれば削除
                localStorage.removeItem('spotify_redirect_after_login');
                
                // URLからハッシュを削除
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // ローカルストレージからセッション情報を取得
                const session = getSessionFromStorage();
                accessToken = session.accessToken;
                sessionId = session.sessionId;
                
                // セッションが古すぎる場合は更新
                const sessionTime = parseInt(session.sessionTime || '0');
                const now = Date.now();
                if (sessionTime && now - sessionTime > 6 * 60 * 60 * 1000) { // 6時間以上経過
                    console.log('Session is too old, refreshing token');
                    if (sessionId) {
                        try {
                            const refreshed = await refreshToken();
                            if (!refreshed) {
                                // トークン更新に失敗した場合は自動再ログイン
                                localStorage.setItem('spotify_redirect_after_login', window.location.href);
                                showError('セッションの有効期限が切れました。自動的に再ログインします...');
                                
                                // 3秒後に自動的にログインページにリダイレクト
                                setTimeout(() => {
                                    window.location.href = '/login';
                                }, 3000);
                                return;
                            }
                        } catch (error) {
                            console.error('Error refreshing token on load:', error);
                            // エラーが発生した場合でもセッションを維持
                        }
                    }
                }
            }
            
            // 最後に再生していた曲の情報を取得
            lastTrackInfo = getLastTrackInfo();
            
            if (accessToken && sessionId) {
                // セッションの有効性をチェック
                const isValid = await checkSessionValidity();
                if (!isValid) {
                    console.log('Session is not valid, trying to refresh token');
                    const refreshed = await refreshToken();
                    if (!refreshed) {
                        console.log('Failed to refresh token, redirecting to login');
                        
                        // 自動再ログイン
                        autoRelogin();
                        return;
                    }
                }
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('controlSection').style.display = 'block';
                
                // 最後に再生していた曲の情報があれば表示
                if (lastTrackInfo) {
                    displayTrackInfo(lastTrackInfo);
                    updateStatusDisplay(false, false);
                }
                
                // 定期的なセッションチェックを設定
                setupSessionCheck();
                
                updatePlaybackState();
                // 定期的に再生状態を更新
                updateInterval = setInterval(updatePlaybackState, 1000);
                
                // ログアウトボタンのイベントリスナーを設定
                document.getElementById('logoutButton').addEventListener('click', logout);
            }
        };

        // エラーメッセージを表示する関数
        let errorTimeout = null;
        function showError(message, duration = 3000) {
            const errorElement = document.getElementById('errorMessage');
            
            // 既存のタイムアウトをクリア
            if (errorTimeout) {
                clearTimeout(errorTimeout);
            }
            
            // シーク操作中のエラーは表示しない（連続操作時）
            if (message.includes('シーク失敗') || message.includes('再生位置')) {
                // シーク操作中のエラーはコンソールにのみ出力
                console.error('シーク操作エラー:', message);
                return;
            }
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // 一定時間後に非表示にする
            errorTimeout = setTimeout(() => {
                errorElement.style.display = 'none';
            }, duration);
        }

        // エラーメッセージを非表示にする関数
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
            errorCount = 0;
            
            // タイムアウトをクリア
            if (errorTimeout) {
                clearTimeout(errorTimeout);
                errorTimeout = null;
            }
        }

        // 認証エラーを処理する関数
        async function handleAuthError() {
            // トークンの更新を試みる
            const refreshed = await refreshToken();
            if (!refreshed) {
                // 更新に失敗した場合は自動再ログイン
                showError('認証の有効期限が切れました。自動的に再ログインします...');
                
                // 自動再ログイン
                autoRelogin();
                
                return false;
            }
            return true;
        }

        // 再生状態を更新する関数
        async function updatePlaybackState() {
            if (!sessionId) {
                return;
            }
            
            try {
                const response = await fetch(`/current-playback?session_id=${sessionId}`);
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        await handleAuthError();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return;
                }
                
                const data = await response.json();
                lastTrackInfo = data;
                
                if (data && data.item) {
                    // 再生中のトラック情報を表示
                    document.getElementById('trackInfo').style.display = 'block';
                    document.getElementById('trackName').textContent = data.item.name;
                    document.getElementById('artistName').textContent = data.item.artists.map(artist => artist.name).join(', ');
                    
                    // アルバムアートを表示
                    if (data.item.album && data.item.album.images && data.item.album.images.length > 0) {
                        document.getElementById('albumArt').src = data.item.album.images[0].url;
                        document.getElementById('albumArt').style.display = 'block';
                    } else {
                        document.getElementById('albumArt').style.display = 'none';
                    }
                    
                    // 再生状態を更新
                    isPlaying = data.is_playing;
                    deviceActive = true;
                    updatePlayPauseButton(isPlaying);
                    
                    // 再生位置を更新
                    updateProgressDisplay(data.progress_ms, data.item.duration_ms);
                    
                    // エラーカウントをリセット
                    errorCount = 0;
                    hideError();
                    
                    // 更新間隔を通常に戻す
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = setInterval(updatePlaybackState, 3000);
                    }
                } else if (data && data.device && !data.device.is_active) {
                    // デバイスが非アクティブな場合
                    deviceActive = false;
                    
                    // 最後に再生していた曲の情報を保持
                    if (lastTrackInfo && lastTrackInfo.item) {
                        const playbackStatusElement = document.getElementById('trackPlaybackStatus');
                        if (playbackStatusElement) {
                            playbackStatusElement.textContent = '一時停止中';
                            playbackStatusElement.style.display = 'block';
                        }
                    } else {
                        const playbackStatusElement = document.getElementById('trackPlaybackStatus');
                        if (playbackStatusElement) {
                            playbackStatusElement.textContent = 'デバイスが接続されていません';
                            playbackStatusElement.style.display = 'block';
                        }
                    }
                    
                    updatePlayPauseButton(false);
                    errorCount++;
                    
                    // エラーが続く場合は更新間隔を長くする
                    if (errorCount > 5 && updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = setInterval(updatePlaybackState, 5000);
                    }
                }
            } catch (error) {
                console.error('Error updating playback state:', error);
                showError('再生状態の取得に失敗しました: ' + error.message);
                errorCount++;
                
                // エラーが続く場合は更新間隔を長くする
                if (errorCount > 5 && updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = setInterval(updatePlaybackState, 5000);
                }
            }
        }

        // 再生位置を変更する関数
        async function seekPosition(position) {
            if (!sessionId) {
                await handleAuthError();
                return false;
            }
            
            if (!deviceActive) {
                // デバイス未接続エラーはコンソールにのみ出力（連続操作時）
                console.error('アクティブなデバイスがありません');
                return false;
            }
            
            try {
                const response = await fetch(`/seek?session_id=${sessionId}&position=${position}`);
                const data = await response.json();
                
                if (data.success) {
                    updatePlaybackState();
                    hideError();
                    return true;
                } else {
                    console.error('Seek failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                return await seekPosition(position);
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            // デバイス未接続エラーはコンソールにのみ出力（連続操作時）
                            console.error('アクティブなデバイスがありません');
                        } else {
                            // シーク失敗エラーはコンソールにのみ出力（連続操作時）
                            console.error('シーク失敗:', data.error);
                        }
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error seeking position:', error);
                // シーク中のエラーはコンソールにのみ出力（連続操作時）
                console.error('シーク中にエラーが発生しました:', error.message);
                return false;
            }
        }

        // 現在の再生位置を取得する関数
        async function getCurrentPosition() {
            if (!sessionId || !deviceActive) {
                return null;
            }
            
            try {
                const response = await fetch(`/current-playback?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data && data.progress_ms !== undefined) {
                    return data.progress_ms;
                }
                return null;
            } catch (error) {
                console.error('Error getting current position:', error);
                return null;
            }
        }

        // 巻き戻しボタンの連続押下を処理する関数
        async function handleSeekBackward() {
            // カウントを増やす
            seekBackwardCount++;
            
            // 既存のタイマーをクリア
            if (seekBackwardTimer) {
                clearTimeout(seekBackwardTimer);
            }
            
            // UIを即時更新（ユーザーフィードバック）
            const button = document.getElementById('seekBackward');
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 100);
            
            // 現在の再生位置表示を即時更新（予測値）
            if (lastTrackInfo && lastTrackInfo.progress_ms !== undefined) {
                const seekAmount = seekBackwardCount * SEEK_STEP;
                const predictedPosition = Math.max(0, lastTrackInfo.progress_ms - seekAmount);
                updateProgressDisplay(predictedPosition, lastTrackInfo.item?.duration_ms || 0);
                
                // 現在の再生位置を更新（UIフィードバック用）
                lastTrackInfo.progress_ms = predictedPosition;
            }
            
            // 一定時間後に実行するタイマーを設定
            seekBackwardTimer = setTimeout(async () => {
                // ボタンを一時的に無効化
                button.disabled = true;
                button.style.opacity = '0.7';
                
                try {
                    // 現在の再生位置を取得
                    const currentPosition = await getCurrentPosition();
                    if (currentPosition !== null) {
                        // 合計の巻き戻し時間を計算
                        const seekAmount = seekBackwardCount * SEEK_STEP;
                        const newPosition = Math.max(0, currentPosition - seekAmount);
                        
                        // 巻き戻し実行
                        await seekPosition(newPosition);
                        
                        // カウントをリセット
                        seekBackwardCount = 0;
                    }
                } catch (error) {
                    console.error('Error in handleSeekBackward:', error);
                } finally {
                    // 処理が完了したらボタンを再度有効化
                    setTimeout(() => {
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 200);
                }
            }, SEEK_TIMEOUT);
        }

        // 早送りボタンの連続押下を処理する関数
        async function handleSeekForward() {
            // カウントを増やす
            seekForwardCount++;
            
            // 既存のタイマーをクリア
            if (seekForwardTimer) {
                clearTimeout(seekForwardTimer);
            }
            
            // UIを即時更新（ユーザーフィードバック）
            const button = document.getElementById('seekForward');
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 100);
            
            // 現在の再生位置表示を即時更新（予測値）
            if (lastTrackInfo && lastTrackInfo.progress_ms !== undefined) {
                const seekAmount = seekForwardCount * SEEK_STEP;
                const predictedPosition = lastTrackInfo.progress_ms + seekAmount;
                updateProgressDisplay(predictedPosition, lastTrackInfo.item?.duration_ms || 0);
                
                // 現在の再生位置を更新（UIフィードバック用）
                lastTrackInfo.progress_ms = predictedPosition;
            }
            
            // 一定時間後に実行するタイマーを設定
            seekForwardTimer = setTimeout(async () => {
                // ボタンを一時的に無効化
                button.disabled = true;
                button.style.opacity = '0.7';
                
                try {
                    // 現在の再生位置を取得
                    const currentPosition = await getCurrentPosition();
                    if (currentPosition !== null) {
                        // 合計の早送り時間を計算
                        const seekAmount = seekForwardCount * SEEK_STEP;
                        const newPosition = currentPosition + seekAmount;
                        
                        // 早送り実行
                        await seekPosition(newPosition);
                        
                        // カウントをリセット
                        seekForwardCount = 0;
                    }
                } catch (error) {
                    console.error('Error in handleSeekForward:', error);
                } finally {
                    // 処理が完了したらボタンを再度有効化
                    setTimeout(() => {
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 200);
                }
            }, SEEK_TIMEOUT);
        }

        // 再生位置表示を更新する関数
        function updateProgressDisplay(progressMs, durationMs) {
            const progressElement = document.getElementById('progressDisplay');
            if (!progressElement) return;
            
            if (progressMs !== undefined && durationMs) {
                const progressSec = Math.floor(progressMs / 1000);
                const durationSec = Math.floor(durationMs / 1000);
                
                const progressMin = Math.floor(progressSec / 60);
                const progressRemainSec = progressSec % 60;
                const durationMin = Math.floor(durationSec / 60);
                const durationRemainSec = durationSec % 60;
                
                const progressFormatted = `${progressMin}:${progressRemainSec.toString().padStart(2, '0')}`;
                const durationFormatted = `${durationMin}:${durationRemainSec.toString().padStart(2, '0')}`;
                
                progressElement.textContent = `${progressFormatted} / ${durationFormatted}`;
            } else {
                progressElement.textContent = '--:-- / --:--';
            }
        }

        // 再生/一時停止を切り替える関数
        async function togglePlayPause() {
            if (!sessionId) {
                await handleAuthError();
                return false;
            }
            
            if (!deviceActive && !isPlaying) {
                // デバイス未接続エラーは通常表示（再生開始時は重要なため）
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return false;
            }
            
            // ボタンを一時的に無効化
            const button = document.getElementById('playPauseButton');
            button.disabled = true;
            button.style.opacity = '0.7';
            
            // UIを即時更新（ユーザーフィードバック）
            const newIsPlaying = !isPlaying;
            updatePlayPauseButton(newIsPlaying);
            
            const endpoint = isPlaying ? '/pause' : '/play';
            try {
                const response = await fetch(`${endpoint}?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    isPlaying = newIsPlaying;
                    document.getElementById('playPauseButton').textContent = isPlaying ? '⏸' : '▶';
                    updateStatusDisplay(true, isPlaying);
                    hideError();
                    return true;
                } else {
                    console.error('Playback toggle failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                return await togglePlayPause();
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            // デバイス未接続エラーは通常表示（再生開始時は重要なため）
                            showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                        } else {
                            // その他のエラーは通常表示
                            showError('再生/一時停止の切り替えに失敗しました: ' + data.error);
                        }
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error toggling playback:', error);
                // その他のエラーは通常表示
                showError('再生/一時停止の切り替え中にエラーが発生しました: ' + error.message);
                return false;
            } finally {
                // 処理が完了したらボタンを再度有効化（少し遅延を入れる）
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                }, 300);
            }
        }

        // イベントリスナーの設定
        document.getElementById('seekBackward').addEventListener('click', async () => {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive) {
                // デバイス未接続エラーはコンソールにのみ出力（連続操作時）
                console.error('アクティブなデバイスがありません');
                return;
            }
            
            // 連続押下処理を実行
            handleSeekBackward();
        });

        document.getElementById('seekForward').addEventListener('click', async () => {
            if (!sessionId) {
                await handleAuthError();
                return;
            }
            
            if (!deviceActive) {
                // デバイス未接続エラーはコンソールにのみ出力（連続操作時）
                console.error('アクティブなデバイスがありません');
                return;
            }
            
            // 連続押下処理を実行
            handleSeekForward();
        });

        document.getElementById('playPauseButton').addEventListener('click', togglePlayPause);

        // ダブルタップによるズームを防止
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ページを離れる時にインターバルをクリア
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
            }
        });

        // 再生/一時停止ボタンの状態を更新する関数
        function updatePlayPauseButton(isPlaying) {
            const button = document.getElementById('playPauseButton');
            if (button) {
                button.textContent = isPlaying ? '⏸' : '▶';
            }
        }

        // 前の曲に移動する関数
        async function previousTrack() {
            if (!sessionId) {
                await handleAuthError();
                return false;
            }
            
            if (!deviceActive) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return false;
            }
            
            // ボタンを一時的に無効化
            const button = document.getElementById('previousTrack');
            button.disabled = true;
            button.style.opacity = '0.7';
            
            try {
                const response = await fetch(`/previous?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    // 再生状態を更新
                    updatePlaybackState();
                    hideError();
                    return true;
                } else {
                    console.error('Previous track failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                return await previousTrack();
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                        } else {
                            showError('前の曲への移動に失敗しました: ' + data.error);
                        }
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error going to previous track:', error);
                showError('前の曲への移動中にエラーが発生しました: ' + error.message);
                return false;
            } finally {
                // 処理が完了したらボタンを再度有効化
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                }, 200);
            }
        }

        // 次の曲に移動する関数
        async function nextTrack() {
            if (!sessionId) {
                await handleAuthError();
                return false;
            }
            
            if (!deviceActive) {
                showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                return false;
            }
            
            // ボタンを一時的に無効化
            const button = document.getElementById('nextTrack');
            button.disabled = true;
            button.style.opacity = '0.7';
            
            try {
                const response = await fetch(`/next?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    // 再生状態を更新
                    updatePlaybackState();
                    hideError();
                    return true;
                } else {
                    console.error('Next track failed:', data);
                    if (data.error) {
                        if (data.error.includes('token') || data.error.includes('unauthorized') || data.error.includes('Invalid or expired session')) {
                            const refreshed = await handleAuthError();
                            if (refreshed) {
                                // トークンが更新されたら再試行
                                return await nextTrack();
                            }
                        } else if (data.error.includes('NO_ACTIVE_DEVICE')) {
                            showError('アクティブなデバイスがありません。Spotifyアプリで再生を開始してください。');
                        } else {
                            showError('次の曲への移動に失敗しました: ' + data.error);
                        }
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error going to next track:', error);
                showError('次の曲への移動中にエラーが発生しました: ' + error.message);
                return false;
            } finally {
                // 処理が完了したらボタンを再度有効化
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                }, 200);
            }
        }

        // 前の曲・次の曲ボタンのイベントリスナーを設定
        document.getElementById('previousTrack').addEventListener('click', previousTrack);
        document.getElementById('nextTrack').addEventListener('click', nextTrack);
    </script>
    <footer style="margin-top: 30px; text-align: center; font-size: 12px; color: #b3b3b3;">
        <p>Spotify Controller v1.5.1 | <a href="#" id="logoutLink" style="color: #1DB954; text-decoration: none;">ログアウト</a></p>
    </footer>
</body>
</html> 